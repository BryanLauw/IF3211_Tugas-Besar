<main class="main top-main">
    <h2>Perhitungan dengan Fenotip</h2>

    <% if flash[:alert] %>
      <div class="flash-message alert" style="background-color: #fff5f5; border: 1px solid #e53e3e; color: #c53030; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.25rem;"><%= flash[:alert] %></div>
    <% end %>
    <% if flash[:info] %>
      <div class="flash-message info" style="background-color: #e6f7ff; border: 1px solid #91d5ff; color: #0050b3; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.25rem;"><%= flash[:info] %></div>
    <% end %>

    <%= form_with(url: process_phenotype_calculator_path, method: :post, local: true, data: { turbo: false }, html: { class: "main-calculator-form" }) do |form| %>
        <%# --- Input Fenotip --- %>
        <div data-controller="dynamic-table" class="dynamic-section">
            <h1>Masukkan fenotip yang ingin diketahui</h1>
            <table class="dynamic-form-table">
                <thead>
                    <tr>
                        <th>Nomor</th>
                        <th>Fenotip</th>
                        <th>Fenotip Ibu</th>
                        <th>Fenotip Ayah</th>
                        <th>Aksi</th>
                    </tr>   
                </thead>
                <tbody data-dynamic-table-target="container">
                    <tr data-dynamic-table-target="row">
                        <td>1</td>
                        <td><%= text_field_tag "calculator[phenotypes][]", nil, class: "table-input", placeholder: "Contoh: Tinggi" %></td>
                        <td>
                            <%= select_tag "calculator[phenotypes_p1][]", options_for_select([["Ada", "Ada"], ["Tidak ada", "Tidak ada"]]), class: "table-select" %>
                        </td>
                        <td>
                            <%= select_tag "calculator[phenotypes_p2][]", options_for_select([["Ada", "Ada"], ["Tidak ada", "Tidak ada"]]), class: "table-select" %>
                        </td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
            <div class="table-actions">
                <button type="button" data-action="click->dynamic-table#addRow" class="button-add-row">+ Tambah Fenotip</button>
            </div>
            <template data-dynamic-table-target="template">
                <tr data-dynamic-table-target="row">
                    <td></td>
                    <td><%= text_field_tag "calculator[phenotypes][]", nil, class: "table-input", placeholder: "Contoh: Tinggi" %></td>
                    <td>
                        <%= select_tag "calculator[phenotypes_p1][]", options_for_select([["Ada", "Ada"], ["Tidak ada", "Tidak ada"]]), class: "table-select" %>
                    </td>
                    <td>
                        <%= select_tag "calculator[phenotypes_p2][]", options_for_select([["Ada", "Ada"], ["Tidak ada", "Tidak ada"]]), class: "table-select" %>
                    </td>
                    <td><button type="button" data-action="click->dynamic-table#removeRow" class="button-remove-row">âœ•</button></td>
                </tr>
            </template>
        </div>

        <%# --- Tombol Submit Utama --- %>
        <div class="table-actions">
            <%= form.submit "Proses Data Fenotip", class: "button-add-row" %>
        </div>
    <% end %> <%# Akhir dari form_with %>

    <% if defined?(@processed_results) && @processed_results.present? %>
    <section class="results-section dynamic-section" id="hasil-input-user" style="margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
        <h1>Input User dan Data API</h1>
        <% @processed_results.each_with_index do |result, index| %>
            <div class="result-item" style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #ccc; border-radius: 0.3rem; background-color: #fdfdfd;">
                <h3 style="margin-top:0; margin-bottom: 0.75rem; font-size: 1.2rem; color: #2c3e50;">
                    Input ke-<%= index + 1 %>: <strong><%= result["phenotype"] || "N/A" %></strong>
                    (<%= result["api_disease_name"] || "Nama API tidak ditemukan" %>)
                </h3>
                <p><strong>Fenotip P1 (Ibu):</strong> <%= result["input_parent1_phenotype"] %></p>
                <p><strong>Fenotip P2 (Ayah):</strong> <%= result["input_parent2_phenotype"] %></p>

                <% if result["api_error"] %>
                    <p style="color: red;"><strong>API Error:</strong> <%= result["api_error"] %></p>
                <% else %>
                    <p><strong>OMIM ID:</strong> <%= result["api_omim_id"] || "Tidak ditemukan" %></p>
                    <p><strong>Tipe Pewarisan dari API:</strong> <%= result["api_inheritance_type"] || "Tidak ditemukan" %></p>
                <% end %>
            </div>
        <% end %>
    </section>
    <% end %>

    <% if defined?(@single_disease_details_all) && @single_disease_details_all.present? %>
    <section class="results-section dynamic-section" id="hasil-kalkulasi-detail" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #aaa;">
        <h1>Detail Kalkulasi Mendel per Penyakit</h1>
        <% @single_disease_details_all.each_with_index do |calc_detail, index| %>
            <div class="calculation-detail-item" style="margin-bottom: 2rem; padding: 1.5rem; border: 1px solid #bbb; border-radius: 0.3rem; background-color: #f0f8ff;">
                <h2 style="margin-top:0; font-size: 1.4rem; color: #1a237e;">
                    Kalkulasi untuk: <%= calc_detail[:phenotype_name] || "Penyakit Tidak Diketahui" %>
                </h2>

                <% if calc_detail[:error] %>
                    <p style="color: red; font-weight: bold;">Error Kalkulasi: <%= calc_detail[:error] %></p>
                <% else %>
                    <p><strong>Tipe Pewarisan Digunakan:</strong> <%= calc_detail[:inheritance_type] %></p>
                    <p><strong>Fenotip Ibu (P1):</strong> <%= calc_detail[:parent1_phenotype_status] %></p>
                    <p><strong>Fenotip Ayah (P2):</strong> <%= calc_detail[:parent2_phenotype_status] %></p>
                    <hr style="margin: 1rem 0;">

                    <h4>Kemungkinan Genotip Orang Tua:</h4>
                    <p><strong>Ibu:</strong> <%= calc_detail[:possible_mother_genotypes]&.join(", ") || "Tidak ada" %></p>
                    <p><strong>Ayah:</strong> <%= calc_detail[:possible_father_genotypes]&.join(", ") || "Tidak ada" %></p>
                    <p><em>Total skenario pasangan genotip orang tua: <%= calc_detail[:num_parent_genotype_scenarios] %></em></p>
                    <hr style="margin: 1rem 0;">

                    <h4>Detail Per Skenario Genotip Orang Tua:</h4>
                    <% calc_detail[:parent_genotype_scenarios_details]&.each_with_index do |scenario, s_idx| %>
                        <div class.scenario-detail style="margin-left: 20px; margin-bottom: 1rem; padding: 0.5rem; border: 1px dashed #ccc;">
                            <strong>Skenario <%= s_idx + 1 %>: Ibu (<%= scenario[:mother_genotype] %>) x Ayah (<%= scenario[:father_genotype] %>)</strong>
                            <p style="margin-left:15px;">Probabilitas Genotip Anak:</p>
                            <ul style="margin-left:30px;">
                                <% scenario[:offspring_genotype_probabilities]&.each do |geno, prob| %>
                                    <li><%= geno %>: <%= (prob * 100).round(2) %>%</li>
                                <% end %>
                            </ul>
                            <p style="margin-left:15px;">Probabilitas Fenotip Anak (untuk skenario ini):</p>
                            <ul style="margin-left:30px;">
                                <% scenario[:offspring_phenotype_probabilities]&.each do |pheno, prob| %>
                                    <li><%= pheno %>: <%= (prob * 100).round(2) %>%</li>
                                <% end %>
                            </ul>
                        </div>
                    <% end %>
                    <hr style="margin: 1rem 0;">

                    <h4>Hasil Akhir Probabilitas Anak (Rata-rata dari semua skenario):</h4>
                    <p><strong>Probabilitas Genotip Anak:</strong></p>
                    <ul style="margin-left:15px;">
                        <% calc_detail[:final_average_offspring_genotype_probabilities]&.each do |geno, prob| %>
                            <li><%= geno %>: <%= (prob * 100).round(2) %>%</li>
                        <% end %>
                    </ul>
                    <p><strong>Probabilitas Fenotip Anak:</strong></p>
                    <ul style="margin-left:15px;">
                        <% calc_detail[:final_average_offspring_phenotype_probabilities]&.each do |pheno, prob| %>
                            <li><%= pheno %>: <%= (prob * 100).round(2) %>%</li>
                        <% end %>
                    </ul>
                <% end %>
            </div>
        <% end %>
    </section>
    <% end %>
</main>